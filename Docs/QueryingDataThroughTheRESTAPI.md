# Querying the Database

The official docs for querying data in Loopback.js are available [here](https://loopback.io/doc/en/lb3/Querying-data.html).

There are several different ways of querying data.

* Through the server side (loopback.js) codebase
* Through the client side (angular2) codebase
* Directly through the REST API as an HTTP call with requests or a similar library

Additionally, once data is in memory, it is parsed and queried using [lodash](https://lodash.com/docs/4.17.11).

# IMPORTANT NOTE

All calls in javascript are done asyncronously. The loopback.js framework uses the [BlueBird Promises](http://bluebirdjs.com/docs/getting-started.html) library and Angular2 uses its own [http](https://angular.io/guide/http) library with what it calls Observables, which are mostly the same thing as Promises, but the syntax is slightly different. There are a ton of examples of this in the codebase, but most important is to note that you cannot simply say something like:

```
//THIS WILL NOT WORK IN JAVSCRIPT
let plates = app.models.Plate.find();
```

But, in languages such as python, you could have a normal return value from the request library.

If you are not used to asynchronous programming please take some time to study the codebase, especially the ExpSet `chemgen-next-server/common/models/ExpSet/extract/ExpSetExtract.ts`.
 
## ExpSet Api

From a practical perspective most of the querying is done for you on the server side through the ExpSet API, which runs all the queries, parses the data and returns it to the REST API.

Most of the time the data that is returned to the client side is generated by the `ExpSet.extract.buildExpSets` function.

# Example - Translate from SQL (Basic No Filters)

## SQL Query

```
SELECT * FROM ExpAssay;
```

## Server Side Query

```
// Path imports are relative in node.js and javascript, so this is relative to wherever your file is
const app = require('server/server.js');
app.models.ExpAssay
.find()
.then((results) =>{
// Do something with the results
})
.catch((error) =>{
// Do something with the error
});
```

## Client Side (Angular2) Query

Note - All REST APIs from server side have their generated functions, but you could call these just as regular http calls the way you would with any REST API.

```
//Class constructor
constructor(private expAssayApi: ExpAssayApi){
}

public getSomeData(){
    this.expAssayApi
    .find()
    .subscribe((results) => {
     // Do something with the results
     }, (error) =>{
     // Do something with the error
     });
}
```

# Example - Translate SQL Query with WHERE

## SQL Query

```
SELECT * FROM Plate WHERE name = 'RNAiI.3A1';
```

## Server Side (Loopback.js) code

```
app.models.Plate
.find({where: {name: 'RNAi.3A1'}})
.then((results) => {
// do something with the results
})
.catch((error) =>{
// do something with the error
});
```


## Client Side (Angular2) code

```
constructor(private plateApi: PlateApi){
}

public getData() {
    this.plateApi
        .find({where: {name: 'RNAi.3A1' }})
        .subscribe((results) => {
        // do something with the results
        }, (error) => {
        // do something with the error
        });
}
```

## Python Example

The server side framework generates a REST API that can be consumed anywhere REST APIs are called

Querying through the REST API directly is a little different, because you have to add in a filter url param, but besides that the where/fields/limit object is example the same.

```
def create_filter_object(barcodes, limit=100):
    filter_object = {}
    filter_object['fields'] = {'csPlateid': True, 'imagepath': True, 'id': True, 'name': True}
    filter_object['where'] = {'name': {'inq': barcodes}}
    filter_object['limit'] = limit
    return filter_object


def get_plates(filter_object):
    r = requests.get('http://onyx.abudhabi.nyu.edu:3000/api/Plates', params={'filter': json.dumps(filter_object)})
    plates = r.json()
```

# Example - Selecting Certain Fields From a Table

## Sql Query

```
SELECT assay_id from ExpAssay where assay_id = 1 limit 100;
```

##  Filter Object

```
{
    where: {assayId: 1},
    limit: 100,
    fields: {assayId: true},
}
```

# Example - Using an OR Filter

## SQL Query

```
SELECT assay_id from ExpAssay where assay_id = 1 OR assay_id = 2 limit 100;
```

There are two different ways to do this query, using the OR or the IN sql operator.
Generally I find the IN operator to be a bit of a simpler syntax, but sometimes you need the OR.

### Filter Object OR/AND Operator

I'm showing OR here, but AND works exactly the same.

```
{
    where: {or: [ {assayId: 1}, {assayId: 2} ] } },
    limit: 100,
    fields: {assayId: true},
}
```

### Filter Object IN Operator

[Offical Loopback.js docs for the IN operator](https://loopback.io/doc/en/lb3/Where-filter.html#inq)
```
{
    where: {assayId: {inq: [1,2]} },
    limit: 100,
    fields: {assayId: true},
}
```

# Example - Complex Query Mixing and Matching And/Or

```
SELECT * FROM RnaiLibrary WHERE
library_id = 1 AND rnai_id = 2
OR
library_id = 1 AND rnai_id = 3
```

This is pretty tricky, because the query has to be EXACTLY like this or else it won't be read in correctly and will probably crash and burn.

If you are having trouble generally the best thing to do is to add a [DEBUG string.](https://loopback.io/doc/en/lb3/Setting-debug-strings.html)

```
{
  "where": {
    "or": [
      {
        "and": [
          {
            "libraryId": 1
          },
          {
            "rnaiId": 2
          }
        ]
      },
      {
        "and": [
          {
            "libraryId": 1
          },
          {
            "rnaiId": 3
          }
        ]
      }
    ]
  }
}
```
